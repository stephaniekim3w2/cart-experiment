<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Campus Closet â€“ Mock Storefront Experiment</title>
  <!-- Tailwind via CDN (no build step needed) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-indigo-700">Campus Closet</h1>
    <div>
      <button id="cartBtn" class="relative text-xl">
        ðŸ›’
        <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center">0</span>
      </button>
    </div>
  </header>

  <main class="flex-1 container mx-auto p-4">
    <!-- Category Tabs -->
    <nav class="mb-4 flex gap-2">
      <button class="tab px-3 py-1 rounded bg-indigo-600 text-white" data-tab="men">Men</button>
      <button class="tab px-3 py-1 rounded bg-gray-200" data-tab="women">Women</button>
    </nav>

    <!-- Product Grid -->
    <div id="productGrid" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
  </main>

  <!-- Cart Overlay -->
  <div id="cartOverlay" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto p-6">
      <h2 class="text-xl font-semibold mb-4 flex justify-between items-center">Your Cart <button id="closeCart" class="text-gray-500 text-lg">âœ–</button></h2>
      <div id="cartItems" class="space-y-3"></div>
      <div id="recommendBlock" class="mt-6 hidden">
        <h3 id="recTitle" class="text-lg font-medium mb-2"></h3>
        <div id="recGrid" class="grid gap-3 grid-cols-2"></div>
      </div>
      <button id="checkoutBtn" class="mt-6 w-full bg-indigo-600 text-white py-2 rounded">Proceed to Checkout</button>
    </div>
  </div>

  <script>
  // ----------  CONFIG  ----------
  const urlParams = new URLSearchParams(window.location.search);
  const condition = urlParams.get('cond') || 'control'; // 'control', 'perso', 'generic'

  // ----------  DATA GENERATION  ----------
  function generateProducts(prefix, count) {
    const categories = ["T-Shirt","Hoodie","Jacket","Jeans","Chinos","Shorts","Sweater","Polo","Dress Shirt","Coat"];
    return Array.from({ length: count }, (_, i) => {
      const id = i + 1;
      const category = categories[i % categories.length];
      return {
        id: `${prefix}-${id}`,
        name: `${prefix === 'men' ? "Men's" : "Women's"} ${category} #${id}`,
        price: (Math.random() * 60 + 15).toFixed(2),
        img: `https://picsum.photos/seed/${prefix}${id}/300/400`,
        desc: `Comfortable ${category.toLowerCase()} ideal for campus life.`,
        gender: prefix
      };
    });
  }
  const menProducts = generateProducts('men', 50);
  const womenProducts = generateProducts('women', 50);
  const allProducts = [...menProducts, ...womenProducts];

  // Preset generic bestâ€‘sellers (first 4 of each category)
  const genericRecs = [...menProducts.slice(0,2), ...womenProducts.slice(0,2)];

  // ----------  STATE  ----------
  let activeTab = 'men';
  const cart = [];

  // ----------  RENDERING  ----------
  const productGrid = document.getElementById('productGrid');
  const cartCount = document.getElementById('cartCount');
  const cartOverlay = document.getElementById('cartOverlay');
  const cartItemsDiv = document.getElementById('cartItems');
  const recBlock = document.getElementById('recommendBlock');
  const recTitle = document.getElementById('recTitle');
  const recGrid = document.getElementById('recGrid');

  function renderGrid() {
    productGrid.innerHTML = '';
    const data = activeTab === 'men' ? menProducts : womenProducts;
    data.forEach(prod => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded shadow p-3 flex flex-col';
      card.innerHTML = `
        <img src="${prod.img}" alt="${prod.name}" class="h-48 w-full object-cover rounded">
        <h4 class="mt-2 font-semibold">${prod.name}</h4>
        <p class="text-sm text-gray-500 flex-1">${prod.desc}</p>
        <div class="mt-2 flex justify-between items-center">
          <span class="font-bold text-indigo-700">$${prod.price}</span>
          <button class="addBtn bg-indigo-600 text-white px-2 py-1 text-sm rounded" data-id="${prod.id}">Add</button>
        </div>
      `;
      productGrid.appendChild(card);
    });
  }

  // ----------  EVENTS  ----------
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.replace('bg-indigo-600','bg-gray-200').classList?.remove('text-white'));
      btn.classList.replace('bg-gray-200','bg-indigo-600');
      btn.classList.add('text-white');
      activeTab = btn.dataset.tab;
      renderGrid();
    });
  });

  productGrid.addEventListener('click', e => {
    if (e.target.classList.contains('addBtn')) {
      const id = e.target.dataset.id;
      const product = allProducts.find(p => p.id === id);
      cart.push(product);
      cartCount.textContent = cart.length;
    }
  });

  document.getElementById('cartBtn').addEventListener('click', () => {
    showCart();
  });
  document.getElementById('closeCart').addEventListener('click', () => {
    cartOverlay.classList.add('hidden');
  });

  document.getElementById('checkoutBtn').addEventListener('click', () => {
    alert('Checkout clicked! (instrument as needed)');
    // Here you could POST abandon=0 to your backend
    window.location.reload();
  });

  window.addEventListener('beforeunload', () => {
    // If needed, POST abandon=1
  }, { once: true });

  function showCart() {
    cartItemsDiv.innerHTML = cart.length ? '' : '<p class="text-sm text-gray-500">Your cart is empty.</p>';
    cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'flex gap-3 items-center';
      div.innerHTML = `
        <img src="${item.img}" class="w-16 h-16 object-cover rounded"/>
        <div class="flex-1">
          <p class="font-medium">${item.name}</p>
          <p class="text-xs text-gray-500">$${item.price}</p>
        </div>
      `;
      cartItemsDiv.appendChild(div);
    });

    // ----- Recommendations -----
    recBlock.classList.add('hidden');
    if (condition !== 'control' && cart.length > 0) {
      let recs = [];
      if (condition === 'perso') {
        // personalized: same gender as majority of cart, exclude items already in cart
        const genderPref = cart.filter(c => c.gender === 'men').length >= cart.filter(c => c.gender === 'women').length ? 'men' : 'women';
        const pool = (genderPref === 'men' ? menProducts : womenProducts).filter(p => !cart.some(c => c.id === p.id));
        recs = pool.sort(() => 0.5 - Math.random()).slice(0,4);
        recTitle.textContent = 'Recommended for You';
      } else if (condition === 'generic') {
        recs = genericRecs;
        recTitle.textContent = 'Customers Love These';
      }
      if (recs.length) {
        recGrid.innerHTML = '';
        recs.forEach(r => {
          const d = document.createElement('div');
          d.className = 'border rounded p-2 text-center';
          d.innerHTML = `<img src="${r.img}" class="h-24 w-full object-cover rounded mb-1"/><p class="text-xs">${r.name}</p>`;
          recGrid.appendChild(d);
        });
        recBlock.classList.remove('hidden');
      }
    }

    cartOverlay.classList.remove('hidden');
  }

  // ----------  INIT  ----------
  renderGrid();
  </script>
</body>
</html>
